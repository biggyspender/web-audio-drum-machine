var Y=Object.defineProperty;var X=(d,b,C)=>b in d?Y(d,b,{enumerable:!0,configurable:!0,writable:!0,value:C}):d[b]=C;var f=(d,b,C)=>X(d,typeof b!="symbol"?b+"":b,C);(function(){"use strict";/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const d=Symbol("Comlink.proxy"),b=Symbol("Comlink.endpoint"),C=Symbol("Comlink.releaseProxy"),S=Symbol("Comlink.finalizer"),E=Symbol("Comlink.thrown"),M=t=>typeof t=="object"&&t!==null||typeof t=="function",z={canHandle:t=>M(t)&&t[d],serialize(t){const{port1:e,port2:s}=new MessageChannel;return k(t,e),[s,[s]]},deserialize(t){return t.start(),H(t)}},D={canHandle:t=>M(t)&&E in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},I=new Map([["proxy",z],["throw",D]]);function V(t,e){for(const s of t)if(e===s||s==="*"||s instanceof RegExp&&s.test(e))return!0;return!1}function k(t,e=globalThis,s=["*"]){e.addEventListener("message",function o(n){if(!n||!n.data)return;if(!V(s,n.origin)){console.warn(`Invalid origin '${n.origin}' for comlink proxy`);return}const{id:a,type:p,path:u}=Object.assign({path:[]},n.data),l=(n.data.argumentList||[]).map(m);let r;try{const i=u.slice(0,-1).reduce((c,g)=>c[g],t),h=u.reduce((c,g)=>c[g],t);switch(p){case"GET":r=h;break;case"SET":i[u.slice(-1)[0]]=m(n.data.value),r=!0;break;case"APPLY":r=h.apply(i,l);break;case"CONSTRUCT":{const c=new h(...l);r=v(c)}break;case"ENDPOINT":{const{port1:c,port2:g}=new MessageChannel;k(t,g),r=F(c,[c])}break;case"RELEASE":r=void 0;break;default:return}}catch(i){r={value:i,[E]:0}}Promise.resolve(r).catch(i=>({value:i,[E]:0})).then(i=>{const[h,c]=w(i);e.postMessage(Object.assign(Object.assign({},h),{id:a}),c),p==="RELEASE"&&(e.removeEventListener("message",o),R(e),S in t&&typeof t[S]=="function"&&t[S]())}).catch(i=>{const[h,c]=w({value:new TypeError("Unserializable return value"),[E]:0});e.postMessage(Object.assign(Object.assign({},h),{id:a}),c)})}),e.start&&e.start()}function _(t){return t.constructor.name==="MessagePort"}function R(t){_(t)&&t.close()}function H(t,e){const s=new Map;return t.addEventListener("message",function(n){const{data:a}=n;if(!a||!a.id)return;const p=s.get(a.id);if(p)try{p(a)}finally{s.delete(a.id)}}),T(t,s,[],e)}function P(t){if(t)throw new Error("Proxy has been released and is not useable")}function A(t){return y(t,new Map,{type:"RELEASE"}).then(()=>{R(t)})}const B=new WeakMap,x="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const e=(B.get(t)||0)-1;B.set(t,e),e===0&&A(t)});function L(t,e){const s=(B.get(e)||0)+1;B.set(e,s),x&&x.register(t,e,t)}function W(t){x&&x.unregister(t)}function T(t,e,s=[],o=function(){}){let n=!1;const a=new Proxy(o,{get(p,u){if(P(n),u===C)return()=>{W(a),A(t),e.clear(),n=!0};if(u==="then"){if(s.length===0)return{then:()=>a};const l=y(t,e,{type:"GET",path:s.map(r=>r.toString())}).then(m);return l.then.bind(l)}return T(t,e,[...s,u])},set(p,u,l){P(n);const[r,i]=w(l);return y(t,e,{type:"SET",path:[...s,u].map(h=>h.toString()),value:r},i).then(m)},apply(p,u,l){P(n);const r=s[s.length-1];if(r===b)return y(t,e,{type:"ENDPOINT"}).then(m);if(r==="bind")return T(t,e,s.slice(0,-1));const[i,h]=O(l);return y(t,e,{type:"APPLY",path:s.map(c=>c.toString()),argumentList:i},h).then(m)},construct(p,u){P(n);const[l,r]=O(u);return y(t,e,{type:"CONSTRUCT",path:s.map(i=>i.toString()),argumentList:l},r).then(m)}});return L(a,t),a}function j(t){return Array.prototype.concat.apply([],t)}function O(t){const e=t.map(w);return[e.map(s=>s[0]),j(e.map(s=>s[1]))]}const N=new WeakMap;function F(t,e){return N.set(t,e),t}function v(t){return Object.assign(t,{[d]:!0})}function w(t){for(const[e,s]of I)if(s.canHandle(t)){const[o,n]=s.serialize(t);return[{type:"HANDLER",name:e,value:o},n]}return[{type:"RAW",value:t},N.get(t)||[]]}function m(t){switch(t.type){case"HANDLER":return I.get(t.name).deserialize(t.value);case"RAW":return t.value}}function y(t,e,s,o){return new Promise(n=>{const a=U();e.set(a,n),t.start&&t.start(),t.postMessage(Object.assign({id:a},s),o)})}function U(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}class q extends AudioWorkletProcessor{constructor(){super();f(this,"running",!1);f(this,"paused",!1);f(this,"nextEventTime",0);f(this,"stepCount",0);f(this,"beatCount",0);f(this,"sampleTime",1/sampleRate);f(this,"pausedStepCount",0);f(this,"pausedBeatCount",0);f(this,"beatsPerBar",4);f(this,"numBars",1);f(this,"subdivisions",4);f(this,"stepCallbacks",new Set);this.port.onmessage=s=>{const{type:o,port:n}=s.data;o==="connect"&&n&&this.setupComlinkEndpoint(n)}}static get parameterDescriptors(){return[{name:"bpm",defaultValue:120,minValue:20,maxValue:960,automationRate:"k-rate"}]}setupComlinkEndpoint(s){const o={start:this.start.bind(this),stop:this.stop.bind(this),pause:this.pause.bind(this),reset:this.reset.bind(this),getState:()=>({running:this.running,beatCount:this.beatCount,stepCount:this.stepCount,nextEventTime:this.nextEventTime,bpm:this.getBpm(),beatsPerBar:this.beatsPerBar,numBars:this.numBars,subdivisions:this.subdivisions}),setBeatsPerBar:n=>{this.beatsPerBar=n},setNumBars:n=>{this.numBars=n},setSubdivisions:n=>{this.subdivisions=n},onStep:v(n=>{this.stepCallbacks.add(n)}),offStep:v(n=>{this.stepCallbacks.delete(n)})};k(o,s)}start(s=currentTime){this.running=!0,this.nextEventTime=s,this.paused?(this.stepCount=this.pausedStepCount,this.beatCount=this.pausedBeatCount,this.paused=!1):(this.stepCount=0,this.beatCount=0)}stop(){this.running=!1,this.paused=!1,this.stepCount=0,this.beatCount=0,this.pausedStepCount=0,this.pausedBeatCount=0}pause(){this.running&&(this.running=!1,this.paused=!0,this.pausedStepCount=this.stepCount,this.pausedBeatCount=this.beatCount)}reset(){this.stepCount=0,this.beatCount=0,this.pausedStepCount=0,this.pausedBeatCount=0,this.paused=!1}getBpm(){return 120}getStepsPerBar(){return this.beatsPerBar*this.subdivisions}calculateBeatInfo(s){const o=this.getStepsPerBar(),n=o*this.numBars,a=s*this.subdivisions%n,p=Math.floor(a/o),u=a%o,l=Math.floor(u/this.subdivisions);return{stepIndex:u%this.subdivisions,beatIndex:l,barIndex:p,beatsPerBar:this.beatsPerBar,numBars:this.numBars,subdivisions:this.subdivisions}}process(s,o,n){if(!this.running)return!0;const u=60/n.bpm[0]/this.subdivisions,l=currentTime;for(let r=0;r<128;r++){const i=l+r*this.sampleTime;if(this.running&&i>=this.nextEventTime){this.beatCount=Math.floor(this.stepCount/this.subdivisions);const h=this.calculateBeatInfo(this.beatCount),c={beatNumber:this.beatCount,stepNumber:this.stepCount,time:this.nextEventTime,actualTime:i,deviation:i-this.nextEventTime,stepIndex:this.stepCount%this.subdivisions,beatIndex:this.beatCount%this.beatsPerBar,barIndex:Math.floor(this.beatCount/this.beatsPerBar)%this.numBars,beatsPerBar:h.beatsPerBar,numBars:h.numBars,subdivisions:h.subdivisions};if(this.stepCallbacks.size>0)for(const g of this.stepCallbacks)try{g(c)}catch(G){console.error("Error in step callback:",G)}this.stepCount++,this.nextEventTime+=u}}return!0}}registerProcessor("sequencer-clock",q)})();
